---
import { Image } from 'astro:assets';
import { getCollection } from 'astro:content';
import type { CollectionEntry } from 'astro:content';

import MainLayout from '@/layouts/MainLayout.astro';
import Card from '@/components/ui/Card.astro';
import CardContent from '@/components/ui/CardContent.astro';

function slugifyTag(s: string) {
  return s
    .toString()
    .trim()
    .toLowerCase()
    .replace(/&/g, 'and')
    .replace(/[^a-z0-9]+/g, '-')
    .replace(/^-+|-+$/g, '');
}

export async function getStaticPaths() {
  const entries = await getCollection('articles');
  const tagMap = new Map<string, string>(); // slug -> display
  const toSlug = (s: string) =>
    s
      .toString()
      .trim()
      .toLowerCase()
      .replace(/&/g, 'and')
      .replace(/[^a-z0-9]+/g, '-')
      .replace(/^-+|-+$/g, '');

  for (const e of entries) {
    const t: unknown = (e as any).data?.tags ?? (e as any).data?.tag ?? [];
    const arr: string[] = Array.isArray(t)
      ? t.map((x) => String(x))
      : t
        ? [String(t as any)]
        : [];
    for (const tag of arr) {
      const slug = toSlug(tag);
      if (!tagMap.has(slug)) tagMap.set(slug, tag);
    }
  }

  return Array.from(tagMap.entries()).map(([slug, display]) => ({
    params: { tag: slug },
    props: { tagDisplay: display },
  }));
}

const { tag } = Astro.params;
const { tagDisplay } = Astro.props as { tagDisplay?: string };

const all: CollectionEntry<'articles'>[] = await getCollection('articles');

const articles = all
  .filter((entry) => {
    const t: unknown =
      (entry as any).data?.tags ?? (entry as any).data?.tag ?? [];
    const arr: string[] = Array.isArray(t)
      ? t.map((x) => String(x))
      : t
        ? [String(t as any)]
        : [];
    return arr.some((x) => slugifyTag(x) === tag);
  })
  .sort(
    (a: CollectionEntry<'articles'>, b: CollectionEntry<'articles'>) =>
      b.data.date.valueOf() - a.data.date.valueOf()
  );

const formatDate = (d: Date) =>
  d.toLocaleDateString('en-US', {
    year: 'numeric',
    month: 'long',
    day: 'numeric',
  });
---

<MainLayout title={`Posts tagged "${tagDisplay ?? tag}"`}>
  <section class="bg-muted/30 w-full px-6 py-16">
    <div class="mx-auto max-w-6xl">
      <div class="mb-12 text-center">
        <h1 class="text-foreground mb-4 text-3xl font-bold md:text-5xl">
          {
            articles.length
              ? `Posts tagged “${tagDisplay ?? tag}”`
              : `No posts for “${tagDisplay ?? tag}”`
          }
        </h1>
        {
          articles.length ? (
            <p class="text-muted-foreground mx-auto max-w-3xl text-xl">
              {articles.length} {articles.length === 1 ? 'post' : 'posts'}{' '}
              found.
            </p>
          ) : (
            <p class="text-muted-foreground mx-auto max-w-3xl text-xl">
              Try a different tag or browse all posts.
            </p>
          )
        }
      </div>

      {
        articles.length ? (
          <div class="grid gap-8 md:grid-cols-2 lg:grid-cols-3">
            {articles.map((entry) => (
              <Card
                href={`/articles/${entry.id}`}
                class="shadow-card space-y-4 overflow-hidden border-0"
              >
                {entry.data.image ? (
                  <Image
                    src={entry.data.image}
                    alt={entry.data.title}
                    class="h-48 w-full object-cover"
                  />
                ) : (
                  <div class="bg-muted h-48" />
                )}
                <CardContent class="p-6">
                  <h3 class="text-foreground mb-3 text-xl leading-tight font-semibold">
                    {entry.data.title}
                  </h3>
                  <div class="text-muted-foreground mb-3 text-sm">
                    {formatDate(entry.data.date)} • {entry.data.author}
                  </div>
                  <p class="text-muted-foreground">{entry.data.excerpt}</p>
                </CardContent>
              </Card>
            ))}
          </div>
        ) : (
          <div class="text-center">
            <a href="/articles" class="underline hover:no-underline">
              Back to all posts
            </a>
          </div>
        )
      }
    </div>
  </section>
</MainLayout>
